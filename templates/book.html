{% extends "base.html" %}

{% block title %}Book a Table - Lakeside Bistro{% endblock %}

{% block extra_css %}
<style>
    .booking-form {
        background: #fff;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    .section-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .section-card:hover {
        border-color: #0d6efd;
        transform: translateY(-5px);
    }
    .section-card.selected {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .time-slot {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        cursor: pointer;
    }
    .time-slot:hover {
        background-color: #f8f9fa;
    }
    .time-slot.selected {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    .section-image {
        height: 200px;
        object-fit: cover;
        border-radius: 5px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold">Book a Table</h1>
                <p class="lead text-muted">Reserve your table at Lakeside Bistro</p>
            </div>

            <!-- Progress Bar -->
            <div class="progress mb-5" style="height: 8px;">
                <div class="progress-bar" role="progressbar" style="width: 33%;" id="progressBar"></div>
            </div>

            <!-- Step 1: Select Section -->
            <div class="booking-form mb-4" id="step1">
                <h3 class="mb-4">1. Select Your Preferred Seating</h3>
                <div class="row">
                    <!-- Lake View -->
                    <div class="col-md-6 mb-4">
                        <div class="section-card" data-section="Lake View">
                            <img src="{{ url_for('static', path='/res.pic.jpg') }}" alt="Lake View" class="img-fluid section-image">
                            <h4>Lake View</h4>
                            <p class="text-muted">Enjoy a beautiful view of the lake while you dine. Tables 10-15.</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-primary">2-12 people</span>
                                <span class="text-muted">Highest Priority</span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">2×2 seaters, 2×4 seaters, 2×12 seaters</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Garden View -->
                    <div class="col-md-6 mb-4">
                        <div class="section-card" data-section="Garden View">
                            <img src="{{ url_for('static', path='/res.pic.jpg') }}" alt="Garden View" class="img-fluid section-image">
                            <h4>Garden View</h4>
                            <p class="text-muted">Relax in our beautiful garden setting. Tables 16-21.</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-primary">2-12 people</span>
                                <span class="text-muted">Second Priority</span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">2×2 seaters, 2×4 seaters, 2×12 seaters</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Indoors -->
                    <div class="col-md-6 mb-4">
                        <div class="section-card" data-section="Indoors">
                            <img src="{{ url_for('static', path='/res.pic.jpg') }}" alt="Indoor Seating" class="img-fluid section-image">
                            <h4>Indoor Seating</h4>
                            <p class="text-muted">Comfortable seating in our climate-controlled dining area. Tables 1-9.</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-primary">2-12 people</span>
                                <span class="text-muted">Third Priority</span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">4×2 seaters, 2×4 seaters, 1×12 seater</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Private Area -->
                    <div class="col-md-6 mb-4">
                        <div class="section-card" data-section="Private Area">
                            <img src="{{ url_for('static', path='/res.pic.jpg') }}" alt="Private Area" class="img-fluid section-image">
                            <h4>Private Area</h4>
                            <p class="text-muted">Exclusive private dining for large groups. Table 22.</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-primary">Up to 30 people</span>
                                <span class="text-muted">Special Priority</span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">1×30 seater U-shaped table</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary" disabled>Previous</button>
                    <button class="btn btn-primary" id="nextToStep2">Next</button>
                </div>
            </div>

            <!-- Step 2: Select Date & Time -->
            <div class="booking-form mb-4 d-none" id="step2">
                <h3 class="mb-4">2. Select Date & Time</h3>
                
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <label for="reservationDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="reservationDate" min="{{ today }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="partySize" class="form-label">Party Size</label>
                        <select class="form-select" id="partySize">
                            <option value="1">1 person</option>
                            <option value="2" selected>2 people</option>
                            <option value="3">3 people</option>
                            <option value="4">4 people</option>
                            <option value="5">5 people</option>
                            <option value="6">6 people</option>
                            <option value="7">7 people</option>
                            <option value="8">8 people</option>
                            <option value="9">9 people</option>
                            <option value="10">10 people</option>
                            <option value="11-20">11-20 people</option>
                            <option value="21-30">21-30 people</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5>Available Time Slots</h5>
                    <div id="timeSlots" class="d-flex flex-wrap">
                        <p class="text-muted">Please select a date to see available time slots</p>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary" id="backToStep1">Previous</button>
                    <button class="btn btn-primary" id="nextToStep3" disabled>Next</button>
                </div>
            </div>

            <!-- Step 3: Guest Information -->
            <div class="booking-form mb-4 d-none" id="step3">
                <h3 class="mb-4">3. Your Information</h3>
                
                <div id="reservationSummary" class="alert alert-info mb-4">
                    <h5>Reservation Details</h5>
                    <p id="summaryText" class="mb-0"></p>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fullName" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="fullName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" id="phone" required>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="specialRequests" class="form-label">Special Requests (Optional)</label>
                        <textarea class="form-control" id="specialRequests" rows="3" placeholder="Any special requirements or requests?"></textarea>
                    </div>
                </div>
                
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="termsCheck" required>
                    <label class="form-check-label" for="termsCheck">
                        I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">terms and conditions</a> *
                    </label>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" id="backToStep2">Previous</button>
                    <button class="btn btn-success" id="confirmBooking">Confirm Booking</button>
                </div>
            </div>
            
            <!-- Confirmation Step -->
            <div class="booking-form text-center d-none" id="confirmation">
                <div class="py-5">
                    <div class="mb-4">
                        <div class="checkmark-circle">
                            <div class="checkmark"></div>
                        </div>
                    </div>
                    <h3 class="mb-3">Reservation Confirmed!</h3>
                    <p class="lead mb-4" id="confirmationMessage"></p>
                    <div class="alert alert-success" id="reservationDetails">
                        <!-- Reservation details will be inserted here by JavaScript -->
                    </div>
                    <p class="text-muted">A confirmation has been sent to your email.</p>
                    <div class="mt-4">
                        <a href="/" class="btn btn-primary me-2">Back to Home</a>
                        <a href="#" class="btn btn-outline-secondary" id="makeAnotherBooking">Make Another Reservation</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms & Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms & Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Reservation Policy</h6>
                <p>We hold reservations for 15 minutes past the scheduled time. After this, we may release your table to other guests.</p>
                
                <h6>Cancellation Policy</h6>
                <p>Please notify us at least 2 hours in advance if you need to cancel or modify your reservation to avoid a cancellation fee.</p>
                
                <h6>Large Parties</h6>
                <p>For parties of 8 or more, a credit card is required to secure the reservation. A cancellation fee may apply for no-shows or late cancellations.</p>
                
                <h6>Seating Preferences</h6>
                <p>While we do our best to accommodate seating preferences, we cannot guarantee specific tables or areas of the restaurant.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get today's date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reservationDate').min = today;
        
        // Initialize variables to store user selections
        let selectedSection = '';
        let selectedDate = '';
        let selectedTime = '';
        let selectedPartySize = 2;
        
        // Step 1: Select Section
        const sectionCards = document.querySelectorAll('.section-card');
        sectionCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selected class from all cards
                sectionCards.forEach(c => c.classList.remove('selected'));
                // Add selected class to clicked card
                this.classList.add('selected');
                selectedSection = this.dataset.section;
            });
        });
        
        // Next button (Step 1 -> Step 2)
        document.getElementById('nextToStep2').addEventListener('click', function() {
            if (!selectedSection) {
                alert('Please select a seating area');
                return;
            }
            
            document.getElementById('step1').classList.add('d-none');
            document.getElementById('step2').classList.remove('d-none');
            document.getElementById('progressBar').style.width = '66%';
            
            // Update summary
            updateSummary();
        });
        
        // Date change handler
        document.getElementById('reservationDate').addEventListener('change', function() {
            selectedDate = this.value;
            if (selectedDate && selectedPartySize) {
                fetchAvailableTimes(selectedDate, selectedPartySize);
            }
        });
        
        // Party size change handler
        document.getElementById('partySize').addEventListener('change', function() {
            selectedPartySize = parseInt(this.value);
            if (selectedDate && selectedPartySize) {
                fetchAvailableTimes(selectedDate, selectedPartySize);
            }
        });
        
        // Time slot click handler
        document.getElementById('timeSlots').addEventListener('click', function(e) {
            if (e.target.classList.contains('time-slot')) {
                // Remove selected class from all time slots
                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.classList.remove('selected');
                });
                
                // Add selected class to clicked time slot
                e.target.classList.add('selected');
                selectedTime = e.target.dataset.time;
                
                // Enable next button
                document.getElementById('nextToStep3').disabled = false;
                
                // Update summary
                updateSummary();
            }
        });
        
        // Back to Step 1
        document.getElementById('backToStep1').addEventListener('click', function() {
            document.getElementById('step2').classList.add('d-none');
            document.getElementById('step1').classList.remove('d-none');
            document.getElementById('progressBar').style.width = '33%';
        });
        
        // Next to Step 3
        document.getElementById('nextToStep3').addEventListener('click', function() {
            if (!selectedTime) {
                alert('Please select a time slot');
                return;
            }
            
            document.getElementById('step2').classList.add('d-none');
            document.getElementById('step3').classList.remove('d-none');
            document.getElementById('progressBar').style.width = '100%';
        });
        
        // Back to Step 2
        document.getElementById('backToStep2').addEventListener('click', function() {
            document.getElementById('step3').classList.add('d-none');
            document.getElementById('step2').classList.remove('d-none');
            document.getElementById('progressBar').style.width = '66%';
        });
        
        // Confirm Booking
        document.getElementById('confirmBooking').addEventListener('click', function() {
            // Validate form
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const termsChecked = document.getElementById('termsCheck').checked;
            
            if (!fullName || !email || !phone) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!termsChecked) {
                alert('Please agree to the terms and conditions');
                return;
            }
            
            // Prepare reservation data
            const reservationData = {
                section: selectedSection,
                date: selectedDate,
                time: selectedTime,
                partySize: selectedPartySize,
                customerName: fullName,
                email: email,
                phone: phone,
                specialRequests: document.getElementById('specialRequests').value.trim()
            };
            
            // Send reservation to server
            submitReservation(reservationData);
        });
        
        // Make Another Booking
        document.getElementById('makeAnotherBooking').addEventListener('click', function(e) {
            e.preventDefault();
            // Reset form
            document.getElementById('confirmation').classList.add('d-none');
            document.getElementById('step1').classList.remove('d-none');
            document.getElementById('progressBar').style.width = '33%';
            
            // Reset form fields
            document.querySelectorAll('input, textarea').forEach(input => {
                input.value = '';
            });
            
            // Reset selections
            selectedSection = '';
            selectedDate = '';
            selectedTime = '';
            selectedPartySize = 2;
            
            // Reset UI
            document.querySelectorAll('.section-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.getElementById('partySize').value = '2';
            document.getElementById('timeSlots').innerHTML = '<p class="text-muted">Please select a date to see available time slots</p>';
        });
        
        // Function to fetch available time slots
        function fetchAvailableTimes(date, partySize) {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            
            // Fetch from API
            fetch(`/api/available-times?date=${date}&party_size=${partySize}&section=${selectedSection}`)
                .then(response => response.json())
                .then(data => {
                    const availableTimes = data.available_times;
                    
                    if (availableTimes.length === 0) {
                        timeSlotsContainer.innerHTML = '<p class="text-muted">No available time slots for the selected date and party size. Please try another date.</p>';
                        return;
                    }
                    
                    let timeSlotsHTML = '';
                    availableTimes.forEach(time => {
                        timeSlotsHTML += `<div class="time-slot" data-time="${time}">${time}</div>`;
                    });
                    
                    timeSlotsContainer.innerHTML = timeSlotsHTML;
                })
                .catch(error => {
                    console.error('Error fetching available times:', error);
                    timeSlotsContainer.innerHTML = '<p class="text-danger">Error loading available times. Please try again.</p>';
                });
        }
        
        // Function to update reservation summary
        function updateSummary() {
            let summaryHTML = `
                <p><strong>Section:</strong> ${selectedSection || 'Not selected'}</p>
            `;
            
            if (selectedDate) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateObj = new Date(selectedDate);
                const formattedDate = dateObj.toLocaleDateString('en-US', options);
                
                summaryHTML += `<p><strong>Date:</strong> ${formattedDate}</p>`;
            }
            
            if (selectedTime) {
                summaryHTML += `<p><strong>Time:</strong> ${selectedTime}</p>`;
            }
            
            summaryHTML += `<p><strong>Party Size:</strong> ${selectedPartySize} ${selectedPartySize === 1 ? 'person' : 'people'}</p>`;
            
            document.getElementById('summaryText').innerHTML = summaryHTML;
        }
        
        // Function to submit reservation to the server
        function submitReservation(reservationData) {
            // Show loading state
            const submitBtn = document.getElementById('confirmBooking');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            // Prepare reservation data for API
            const apiData = {
                customer_name: reservationData.customerName,
                customer_email: reservationData.email,
                customer_phone: reservationData.phone,
                party_size: reservationData.partySize,
                reservation_date: reservationData.date + 'T' + reservationData.time + ':00',
                reservation_time: reservationData.time,
                section_preference: reservationData.section,
                special_requests: reservationData.specialRequests
            };
            
            // Send to API
            fetch('/api/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(apiData)
            })
            .then(response => response.json())
            .then(data => {
                // Hide the form and show confirmation
                document.getElementById('step3').classList.add('d-none');
                
                // Format the reservation details for display
                const formattedDate = new Date(reservationData.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                let reservationDetails = '';
                
                if (data.success) {
                    reservationDetails = `
                        <h5>Reservation Confirmed!</h5>
                        <p><strong>Name:</strong> ${reservationData.customerName}</p>
                        <p><strong>Date & Time:</strong> ${formattedDate} at ${reservationData.time}</p>
                        <p><strong>Section:</strong> ${reservationData.section}</p>
                        <p><strong>Party Size:</strong> ${reservationData.partySize} ${reservationData.partySize === 1 ? 'person' : 'people'}</p>
                        ${reservationData.specialRequests ? `<p><strong>Special Requests:</strong> ${reservationData.specialRequests}</p>` : ''}
                        <hr>
                        <p class="mb-0">A confirmation has been sent to <strong>${reservationData.email}</strong></p>
                    `;
                } else {
                    reservationDetails = `
                        <h5>Alternative Options Available</h5>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <p><strong>Name:</strong> ${reservationData.customerName}</p>
                        <p><strong>Date & Time:</strong> ${formattedDate} at ${reservationData.time}</p>
                        <p><strong>Party Size:</strong> ${reservationData.partySize} ${reservationData.partySize === 1 ? 'person' : 'people'}</p>
                        <hr>
                        <p class="mb-0">Please contact us to confirm your preferred alternative.</p>
                    `;
                }
                
                document.getElementById('reservationDetails').innerHTML = reservationDetails;
                document.getElementById('confirmation').classList.remove('d-none');
                
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error submitting reservation:', error);
                alert('Error submitting reservation. Please try again.');
                
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        }
    });
</script>
{% endblock %}
